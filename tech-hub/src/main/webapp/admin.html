<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TechHub Italia - Admin</title>

  <!-- Bootstrap (load first) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Il tuo CSS unificato (sovrascrive i bottoni Bootstrap) -->
  <link rel="stylesheet" href="css/prova.css">
</head>

<!-- aggiunta classe admin-area per stili specifici -->
<body class="admin-area">
  <div class="container my-5">

    <h1 class="text-center text-primary mb-4"><i class="bi bi-shield-lock me-2"></i>Admin - Gestione Posizioni</h1>

    <div class="text-end mb-4">
      <a href="prova.html" class="btn btn-primary btn-lg btn-icon">
        <i class="bi bi-arrow-left-circle"></i> Torna al sito
      </a>
    </div>

    <!-- BARRA FILTRI: richiesta -->
    <div class="card p-3 mb-4 filter-bar">
      <div class="row g-2 align-items-center">
        <div class="col-md-6">
          <label for="filterText" class="form-label mb-1">Cerca (titolo / descrizione)</label>
          <input id="filterText" class="form-control" type="text" placeholder="Inserisci testo da cercare...">
        </div>
        <div class="col-md-3">
          <label for="filterCity" class="form-label mb-1">Sede</label>
          <select id="filterCity" class="form-select">
            <option value="">Tutte le sedi</option>
            <option value="Milano, Italia">Milano</option>
            <option value="Roma, Italia">Roma</option>
            <option value="Torino, Italia">Torino</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterContract" class="form-label mb-1">Contratto</label>
          <select id="filterContract" class="form-select">
            <option value="">Tutti i contratti</option>
            <option value="Indeterminato">Indeterminato</option>
            <option value="Determinato">Determinato</option>
            <option value="Part-time">Part-time</option>
          </select>
        </div>
      </div>
      <div class="mt-3 text-end">
        <button id="resetFilters" class="btn btn-primary btn-lg btn-icon">Reset filtri</button>
      </div>
    </div>

    <!-- ======================================================
         SEZIONE CREAZIONE NUOVO ANNUNCIO
         ====================================================== -->

    <div class="card p-4 mb-5">
  <h4 class="mb-4 text-center text-primary"><i class="bi bi-plus-circle me-2"></i>Crea Nuovo Annuncio</h4>

  <!-- form che invia campi con nomi uguali alle colonne della tabella JOBOPENINGS -->
  <form id="createJobForm" method="post" action="/api/jobopenings/create">
    <!-- campi nascosti DB -->
    <input type="hidden" name="JOBOPENINGID" id="JOBOPENINGID" value=""> <!-- valorizzare lato server se update -->
    <input type="hidden" name="LATITUDE" id="LATITUDE" value="">
    <input type="hidden" name="LONGITUDE" id="LONGITUDE" value="">
    <input type="hidden" name="CREATEDAT" id="CREATEDAT" value="">
    <input type="hidden" name="UPDATEDAT" id="UPDATEDAT" value="">
    <input type="hidden" name="TESTID" id="TESTID" value="">
    <div class="row g-3">
      <div class="col-md-6">
        <label for="TITLE" class="form-label">Titolo Posizione</label>
        <!-- name e id corrispondono al campo TITLE del DB -->
        <input type="text" class="form-control" id="TITLE" name="TITLE"
               placeholder="Esempio: Sviluppatore Frontend" required>
      </div>

      <div class="col-md-6">
        <label for="EMPTYTYPEID" class="form-label">Categoria / Tipo</label>
        <!-- EMPTYTYPEID: corrisponde alla tabella EMPTYTYPES -->
        <select class="form-select" id="EMPTYTYPEID" name="EMPTYTYPEID" required>
          <option value="">Seleziona categoria</option>
          <!-- valori di esempio: usare gli ID reali dal DB -->
          <option value="1">Sviluppo Software</option>
          <option value="2">Consulenza e Analisi</option>
          <option value="3">Data & BI</option>
          <option value="4">Logistica e Operazioni</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="CITYID" class="form-label">Sede (CITYID)</label>
        <!-- CITYID: invia l'ID della città, non la stringa "Milano, Italia" -->
        <select class="form-select" id="CITYID" name="CITYID" required>
          <option value="">Seleziona sede</option>
          <!-- esempio con ID numerici: sostituire con i CITYID reali -->
          <option value="10">Milano</option>
          <option value="20">Roma</option>
          <option value="30">Torino</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="WORKSCHEDID" class="form-label">Tipo Contratto / Orario (WORKSCHEDID)</label>
        <!-- WORKSCHEDID corrisponde alla tabella WORKSCHEDS -->
        <select class="form-select" id="WORKSCHEDID" name="WORKSCHEDID" required>
          <option value="">Seleziona contratto</option>
          <!-- valori di esempio: usare gli ID reali dalla tabella WORKSCHEDS -->
          <option value="1">Indeterminato (Full-time)</option>
          <option value="2">Determinato</option>
          <option value="3">Part-time</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="RALFROM" class="form-label">RAL (da)</label>
        <input type="number" class="form-control" id="RALFROM" name="RALFROM" placeholder="Es. 30000">
      </div>

      <div class="col-md-6">
        <label for="RALTO" class="form-label">RAL (a)</label>
        <input type="number" class="form-control" id="RALTO" name="RALTO" placeholder="Es. 45000">
      </div>

      <div class="col-12">
        <label for="DESCRIPTION" class="form-label">Descrizione Posizione</label>
        <!-- DESCRIPTION: campo testuale grande -->
        <textarea class="form-control" id="DESCRIPTION" name="DESCRIPTION" rows="4"
                  placeholder="Descrivi le responsabilità, i requisiti e le competenze..." required></textarea>
      </div>

      <div class="col-md-6">
        <label for="CLOSINGDATE" class="form-label">Data di Chiusura</label>
        <input type="date" class="form-control" id="CLOSINGDATE" name="CLOSINGDATE">
      </div>

      <div class="col-md-6">
        <label for="ISOPEN" class="form-label">Stato Annuncio</label>
        <select class="form-select" id="ISOPEN" name="ISOPEN" required>
          <option value="1">Aperto</option>
          <option value="0">Chiuso</option>
        </select>
      </div>
    </div>

    <div class="mt-4 text-center">
      <button type="submit" class="btn btn-primary btn-lg btn-icon">
        <i class="bi bi-plus-circle"></i> Crea Annuncio
      </button>
    </div>
  </form>
</div>


    <!-- ======================================================
         SEZIONE LISTA ANNUNCI
         ====================================================== -->

    <div class="card p-4 shadow-sm">
      <h4 class="mb-4 text-center text-primary"><i class="bi bi-card-list me-2"></i>Annunci Esistenti</h4>
      <div id="jobList" class="accordion"></div>
    </div>
  </div>

  <!-- ======================================================
       MODALE PER VISUALIZZARE I CANDIDATI
       ====================================================== -->

  <div class="modal fade" id="candidatesModal" tabindex="-1" aria-labelledby="candidatesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="candidatesModalLabel"><i class="bi bi-people-fill me-2"></i>Candidati Posizione</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <ul id="candidateList" class="list-group candidate-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <footer>
    © 2024 TechHub Italia - Pannello Admin
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>



  <script>
    let jobs = [];

    // --- LO SCRIPT VA SISTEMATO E SPOSTATO  ---
    function getActiveFilters() {
      return {
        text: document.getElementById('filterText').value.trim().toLowerCase(),
        city: document.getElementById('filterCity').value,
        contract: document.getElementById('filterContract').value
      };
    }

    // CREAZIONE NUOVO ANNUNCIO
    document.getElementById('createJobForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const job = {
        id: Date.now(),
        title: document.getElementById('jobTitle').value,
        category: document.getElementById('jobCategory').value,
        city: document.getElementById('jobCity').value,
        contract: document.getElementById('jobContract').value,
        description: document.getElementById('jobDescription').value,
        status: 'Aperto',
        candidates: []
      };
      jobs.push(job);
      renderJobs();
      this.reset();
    });

    // EVENTI FILTRI
    document.getElementById('filterText').addEventListener('input', renderJobs);
    document.getElementById('filterCity').addEventListener('change', renderJobs);
    document.getElementById('filterContract').addEventListener('change', renderJobs);
    document.getElementById('resetFilters').addEventListener('click', function () {
      document.getElementById('filterText').value = '';
      document.getElementById('filterCity').value = '';
      document.getElementById('filterContract').value = '';
      renderJobs();
    });

    // RENDER ANNUNCI (applica filtri attivi)
    function renderJobs() {
      const jobList = document.getElementById('jobList');
      jobList.innerHTML = '';

      const filters = getActiveFilters();

      // applica i filtri
      const filtered = jobs.filter(job => {
        // filtro testo sul title e description
        if (filters.text) {
          const hay = (job.title + ' ' + job.description + ' ' + job.category).toLowerCase();
          if (!hay.includes(filters.text)) return false;
        }
        if (filters.city) {
          if (job.city !== filters.city) return false;
        }
        if (filters.contract) {
          if (job.contract !== filters.contract) return false;
        }
        return true;
      });

      if (filtered.length === 0) {
        jobList.innerHTML = '<div class="text-center py-4 text-muted">Nessun annuncio corrisponde ai filtri.</div>';
        return;
      }

      filtered.forEach((job) => {
        const jobCard = document.createElement('div');
        jobCard.classList.add('accordion-item');
        jobCard.innerHTML = `
          <h2 class="accordion-header" id="heading${job.id}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${job.id}" aria-expanded="false" aria-controls="collapse${job.id}">
              ${job.title} - <span class="badge badge-status ${job.status === 'Aperto' ? 'bg-success' : 'bg-secondary'}">${job.status}</span>
            </button>
          </h2>
          <div id="collapse${job.id}" class="accordion-collapse collapse" aria-labelledby="heading${job.id}">
            <div class="accordion-body">
              <p><strong>Categoria:</strong> ${job.category}</p>
              <p><strong>Sede:</strong> ${job.city}</p>
              <p><strong>Contratto:</strong> ${job.contract}</p>
              <p><strong>Descrizione:</strong> ${job.description}</p>
              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-outline-primary btn-sm btn-icon" onclick="toggleJobStatus(${job.id})">
                  <i class="bi bi-pencil-square"></i> ${job.status === 'Aperto' ? 'Chiudi Annuncio' : 'Riapri Annuncio'}
                </button>
                <button class="btn btn-outline-primary btn-sm btn-icon" onclick="viewCandidates(${job.id})">
                  <i class="bi bi-people-fill"></i> Visualizza Candidati (${job.candidates.length})
                </button>
              </div>
            </div>
          </div>
        `;
        jobList.appendChild(jobCard);
      });
    }

    function toggleJobStatus(id) {
      const job = jobs.find(j => j.id === id);
      if (job) {
        job.status = job.status === 'Aperto' ? 'Chiuso' : 'Aperto';
        renderJobs();
      }
    }

    function viewCandidates(id) {
      const job = jobs.find(j => j.id === id);
      const candidateList = document.getElementById('candidateList');
      candidateList.innerHTML = '';
      if (job && job.candidates.length) {
        job.candidates.forEach(c => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${c.name} - ${c.email}`;
          candidateList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = 'Nessun candidato per questo annuncio.';
        candidateList.appendChild(li);
      }
      new bootstrap.Modal(document.getElementById('candidatesModal')).show();
    }

  </script>
</body>
</html>              